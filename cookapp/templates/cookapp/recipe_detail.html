{% extends "cookapp/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <!-- Recipe Title Section -->
    <div class="recipe-header text-center py-3 mb-4" style="background-color: #f7f7f7; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: center; align-items: center;">
            <h1 class="display-4 font-weight-bold mb-3" style="color: #333; font-size: 2.5rem; margin: 0; display: inline;">{{ recipe.title }}</h1>
            
            <!-- Tags Section -->
            {% if recipe.tags %}
            <div class="tags-section" style="display: inline-block; margin-left: 20px;">
                {% for tag in recipe.tags %}
                <span class="badge badge-pill" style="background-color: #7eacb5; color: white; padding: 6px 12px; font-size: 13px; margin: 3px;">{{ tag }}</span>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Favorite Button -->
            {% if user.is_authenticated %}
            <form action="{% url 'toggle_favorite' recipe.id %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn-primary-favorite" style="position: absolute; top: 20px; right: 20px;">
                <strong>{% if is_favorited %}Remove from{% else %}Add to{% endif %} Favorites</strong>
                </button>
            </form>
            {% else %}
            <a href="{% url 'login' %}" class="btn-primary-favorite" style="position: absolute; top: 20px; right: 20px;">Log in to add to Favorites</a>
            {% endif %}
        </div>
        
        <!-- Recipe Image -->
        {% if recipe.image %}
            <img src="{{ recipe.image }}" alt="{{ recipe.title }}" class="img-fluid my-4" style="max-width: 500px; height: auto; border-radius: 15px; box-shadow: 0 6px 10px rgba(0,0,0,0.15);">
        {% endif %}
    </div>

    <!-- Ingredients Section -->
    <div class="ingredients-section py-4 px-5 mb-5" style="background-color: #eaf2f8; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h3 class="font-weight-bold mb-4" style="color: #2874a6;">Ingredients</h3>
        <ul class="list-group">
            {% for recipe_ingredient in recipe.recipeingredient_set.all %}
                <li class="list-group-item" style="border: none; background-color: #d6eaf8; border-radius: 5px; margin-bottom: 8px;">
                    <i class="fa fa-check-circle" style="color: #2ecc71; margin-right: 8px;"></i> 
                    {{ recipe_ingredient.quantity }} {{ recipe_ingredient.ingredient.name }}
                </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Instructions Section -->
    <div class="instructions-section py-4 px-5 mb-5" style="background-color: #fdfefe; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h3 class="font-weight-bold mb-4" style="color: #2874a6;">Instructions</h3>
        <p style="line-height: 1.8; color: #2c3e50; white-space: pre-line;">{{ recipe.instructions }}</p>
    </div>

    <!-- Nutrition Information Section -->
    {% if recipe.calories or recipe.macros %}
        <div class="nutrition-section py-4 px-5 mb-5" style="background-color: #e8f8f5; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 class="font-weight-bold mb-4" style="color: #2874a6;">Nutrition Information</h3>
            <ul class="list-group">
                {% if recipe.calories %}
                    <li class="list-group-item" style="border: none; background-color: #d1f2eb; border-radius: 5px; margin-bottom: 8px;">
                        <strong>Calories:</strong> {{ recipe.calories }} kcal
                    </li>
                {% endif %}
                {% if recipe.macros %}
                    {% for macro, value in recipe.macros.items %}
                        <li class="list-group-item" style="border: none; background-color: #d1f2eb; border-radius: 5px; margin-bottom: 8px;">
                            <strong>{{ macro|title }}:</strong> {{ value }} g
                        </li>
                    {% endfor %}
                {% endif %}
            </ul>
        </div>
    {% endif %}

    <!-- Tags Section -->
    {% if recipe.tags %}
        <div class="tags-section text-center py-3 px-5 mb-5" style="background-color: #f5f5f5; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h4 class="font-weight-bold mb-3" style="color: #2874a6;">Tags</h4>
            <p>
                {% for tag in recipe.tags %}
                    <span class="badge badge-pill" style="background-color: #3498db; color: white; padding: 8px 15px; font-size: 14px; margin: 3px;">{{ tag }}</span>
                {% endfor %}
            </p>
        </div>
    </div>
</div>


<!-- PDF Download Button at the bottom -->
<div class="text-center mt-4">
    <button id="pdfDownloader" class="btn btn-primary">Download Recipe as PDF</button>
</div>
</div>

<!-- Include jsPDF and html2canvas Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- JavaScript for PDF Download -->
<script>
    document.getElementById('pdfDownloader').addEventListener('click', function() {
        document.body.classList.add('pdf-mode');
    
        // Use html2canvas with specific options to ensure images are fully loaded and rendered
        html2canvas(document.querySelector('.container'), {
            allowTaint: true, // Enables cross-origin images to be captured
            useCORS: true,    // Ensures CORS-enabled images are rendered
            logging: true     // Logs process steps for debugging if needed
        }).then(function(canvas) {
            var imgData = canvas.toDataURL('image/png');
    
            // Initialize jsPDF correctly based on the library's version
            const { jsPDF } = window.jspdf;
            var doc = new jsPDF('p', 'mm', 'a4');
    
            // Page dimensions in mm
            var pageWidth = doc.internal.pageSize.width;
            var pageHeight = doc.internal.pageSize.height;
    
            // Calculate dimensions to fit the page while preserving aspect ratio
            var imgWidth = pageWidth;
            var imgHeight = canvas.height * imgWidth / canvas.width;
            if (imgHeight > pageHeight) {
                imgHeight = pageHeight;
                imgWidth = canvas.width * imgHeight / canvas.height;
            }
    
            // Add the image to the PDF
            doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
            doc.save('{{ recipe.title }}.pdf');
    
            document.body.classList.remove('pdf-mode');
        }).catch(error => {
            console.error("Error generating PDF: ", error);
        });
    });
    </script>
{% endblock %}
